<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>BabiaXR - Multiuser Babia-boats Demo</title>
    <meta name="description" content="Babiaxr multiuser demo using babia-boats.">
    </meta>
    <!-- Aframe -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.0/dist/aframe-extras.min.js"></script>
    <script
        src="https://unpkg.com/aframe-environment-component@1.2.0/dist/aframe-environment-component.min.js"></script>
    <script src="../../dist/aframe-babia-components.js"></script>
    <!-- Mulituser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js"></script>
    <script src="./easyrtc.js"></script>
    <script src="https://unpkg.com/networked-aframe@^0.8.0/dist/networked-aframe.js"></script>
    <!-- Gitlab Corner -->
    <link rel="stylesheet" href="../assets/gitlab-corner.css">
</head>

<body>
    <a-scene id="AframeScene" networked-scene="
        room: multi_boats_selector;
        adapter: easyrtc;
        debug: true;
        audio: false;
        serverURL: https://f-l2108-pc02.aulas.etsit.urjc.es:49153/;
        ">

        <a-assets>
            <!-- Dummy asset to make the scene sync (WIP)-->
            <img src="https://wallpapercave.com/wp/wp2345390.jpg?dummy=8484744">

            <!-- Templates -->
            <template id="selector-template">
                <a-entity class="selector"></a-entity>
            </template>
            <template id="nav-template">
                <a-entity class="nav"></a-entity>
            </template>
            <template id="controls-template">
                <a-entity class="controls"></a-entity>
            </template>
        </a-assets>

        <!-- Environment -->
        <a-entity environment="preset: yavapai" renderer="antialias: true"></a-entity>

            <!-- No sync entities -->
            <!-- Slider -->
            <a-entity id="nav" babia-navigator position="6 1 1" rotation="0 0 0" scale="0.5 0.5 0.5"
            networked="template:#nav-template; networkId:nav; persistent: true; owner: scene"></a-entity>

            <!-- Sync entities, persistent -->
            <!-- Querier -->
            <a-entity id="querier" babia-queryjson="url: ./commits2.json;"></a-entity>
            <!-- 3 Selector -->
            <a-entity id="selector" babia-selector="from: querier; controller: nav"
            networked="template:#selector-template; networkId:selector; persistent: true; owner: scene"></a-entity>
            <!-- Treebuilder -->
            <a-entity id="treebuilder" babia-treebuilder="field: path; split_by: /; from: selector"></a-entity>

            <!-- Boats Visualizer -->
            <a-entity id="boats" babia-boats="from: treebuilder; area: area" 
            position="1 0.1 0" scale="0.3 0.3 0.3"></a-entity>

            <!--Sync entities, not persistent-->
            <!-- Camera -->
            <a-entity id="rig" position="2.25 1.6 3" rotation="0 0 0">
                <a-entity id="camera" camera look-controls wasd-controls="fly: false">
                    <a-sphere id="avatar" color="#D3FFE4" scale="0.25 0.25 0.25">
                        <a-text id="username-tag" 
                        position="-0.5 1.5 0" width="5" color="black" value="username"></a-text>
                    </a-sphere>
                </a-entity>
            </a-entity>
            <!-- Hand Controls -->
            <a-entity id="leftHand" oculus-touch-controls="hand: left"
                teleport-controls="cameraRig: #rig; teleportOrigin: #avatar;  collisionEntities: #environmentGround;
                        hitCylinderColor: #ff3468; curveHitColor: #ff3468; curveMissColor: #333333; curveLineWidth: 0.01; button: trigger"></a-entity>
            <a-entity id="rightHand" laser-controls="hand: right" oculus-touch-controls="hand: right"
                raycaster="objects: .babiaxraycasterclass, #audio_button"></a-entity>
            <a-entity id="cursor" cursor="rayOrigin:mouse" raycaster="objects: .babiaxraycasterclass, #audio_button">
            </a-entity>

    </a-scene>

    <script>
        let selector = document.getElementById('selector')
        let nav = document.getElementById('nav')
        /*let controls;

    document.body.addEventListener('entityCreated', function (event) {
        if(event.detail.el === nav){
            controls = nav.children[1]
            controls.setAttribute('networked',{
            "template": "#controls-template",
            "networkId": "controls",
            "persistent": true,
            "owner": "scene"
        })
        }
    });*/
        
        document.body.addEventListener('clientConnected', function (event) {
            let clientId = event.detail.clientId;
            console.log('clientConnected event. clientId =', clientId);
            console.log("Selector owner: ", selector.components.networked.data.owner);
            let imFirst = true
            if (selector.components.networked.data.owner == 'scene'){
                for (client in NAF.connection.getConnectedClients()){
                    let otherTime = NAF.connection.getConnectedClients()[client].roomJoinTime
                    let myTime = NAF.connection.adapter._myRoomJoinTime
                    console.log("Other: ", otherTime)
                    console.log("Mine: ", myTime)
                    if (myTime > otherTime){
                        imFirst = false;
                    }
                }
                if (imFirst) {
                    NAF.utils.takeOwnership(selector)
                    NAF.utils.takeOwnership(nav)
                   // NAF.utils.takeOwnership(controls)
                } else { 
                    console.log("I'm not creator")
                    nav.children[1].setAttribute('visible', false)
                    nav.children[2].setAttribute('visible', false)
                    nav.children[3].setAttribute('visible', false)
                }
            }
        });
        
        
        nav.addEventListener('click', function () {
            if (!NAF.utils.isMine(selector) && !NAF.utils.isMine(nav)){
                NAF.utils.takeOwnership(selector)
                NAF.utils.takeOwnership(nav)
               // NAF.utils.takeOwnership(controls)
            } else {
                setSelectorValue()
            }          
        })

        selector.addEventListener('ownership-gained', e => {
            console.log("Selector ownership gained")
            setSelectorValue()
            nav.children[1].setAttribute('visible', true)
            nav.children[2].setAttribute('visible', true)
            nav.children[3].setAttribute('visible', true)
        });


        selector.addEventListener('ownership-lost', e => {
            console.log("Selector ownership lost")
            nav.children[1].setAttribute('visible', false)
            nav.children[2].setAttribute('visible', false)
            nav.children[3].setAttribute('visible', false)
        });

        function setSelectorValue(){
            console.log ("Set current_value: " + selector.components['babia-selector'].selectable.current)
            selector.setAttribute('babia-selector', 'current_value', selector.components['babia-selector'].selectable.current)
        }
    </script>
    <script>
        NAF.schemas.add({
            template: '#selector-template',
            components: [
                'babia-selector'
            ]
        })
        NAF.schemas.add({
            template: '#nav-template',
            components: [
                'babia-navigator'
            ]
        })
        /*
        NAF.schemas.add({
            template: '#controls-template',
            components: [
                'babia-controls'
            ]
        })*/
    </script>
</body>

</html>